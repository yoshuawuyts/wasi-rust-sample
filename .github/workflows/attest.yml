name: build-attested-component

on:
  push:
    branches: [cosign]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      packages: write
      contents: read
      attestations: write
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Attest
        uses: actions/attest@v1
        id: attest
        with:
          subject-name: ghcr.io/yoshuawuyts/rust-wasi-hello
          # subject-digest: ${{ steps.push.outputs.digest }}
          subject-digest: sha256:67940472ac167f1c79224ee645ba59ca54483d95c633f9e67a4d16719d1fa356
          predicate-type: "https://in-toto.io/attestation/release/v0.1"
          predicate: '{"purl":"pkg:oci/..."}'
          push-to-registry: true
